#include <Wire.h>
#include <Adafruit_BMP280.h>

#define MPU_ADDR 0x68   // I2C address of MPU9250
#define BMP_ADDR 0x76   // I2C address of BMP280 (sometimes 0x77)

Adafruit_BMP280 bmp; 

void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22);  // SDA, SCL (ESP32 default pins)

  // Wake up MPU9250
  Wire.beginTransmission(MPU_ADDR);
  Wire.write(0x6B); 
  Wire.write(0);    
  Wire.endTransmission(true);

  // Initialize BMP280
  if (!bmp.begin(BMP_ADDR)) {
    Serial.println("Could not find BMP280 sensor!");
    while (1);
  }

  Serial.println("GY-91 Initialized ✅ (MPU9250 + BMP280)");
}

void loop() {
  // ----- Read MPU9250 -----
  Wire.beginTransmission(MPU_ADDR);
  Wire.write(0x3B); // starting register
  Wire.endTransmission(false);
  Wire.requestFrom(MPU_ADDR, 14, true);

  int16_t AcX = Wire.read() << 8 | Wire.read();
  int16_t AcY = Wire.read() << 8 | Wire.read();
  int16_t AcZ = Wire.read() << 8 | Wire.read();
  int16_t Tmp = Wire.read() << 8 | Wire.read(); // skip temp
  int16_t GyX = Wire.read() << 8 | Wire.read();
  int16_t GyY = Wire.read() << 8 | Wire.read();
  int16_t GyZ = Wire.read() << 8 | Wire.read();

  // Convert raw to real units
  float Ax = AcX / 16384.0;  // g
  float Ay = AcY / 16384.0;
  float Az = AcZ / 16384.0;

  float Gx = GyX / 131.0;    // °/s
  float Gy = GyY / 131.0;
  float Gz = GyZ / 131.0;

  // Calculate pitch & roll
  float pitch = atan2(Ay, sqrt(Ax * Ax + Az * Az)) * 180.0 / PI;
  float roll  = atan2(-Ax, Az) * 180.0 / PI;

  // ----- Read BMP280 -----
  float pressure = bmp.readPressure() / 100.0; // hPa
  float altitude = bmp.readAltitude(1013.25);  // meters

  // ===== Print results nicely =====
  Serial.println(F("========================================"));
  Serial.print(F("Accel [g]    → X=")); Serial.print(Ax, 2);
  Serial.print(F("  Y=")); Serial.print(Ay, 2);
  Serial.print(F("  Z=")); Serial.println(Az, 2);

  Serial.print(F("Gyro [°/s]  → X=")); Serial.print(Gx, 2);
  Serial.print(F("  Y=")); Serial.print(Gy, 2);
  Serial.print(F("  Z=")); Serial.println(Gz, 2);

  Serial.print(F("Orientation → Pitch=")); Serial.print(pitch, 1);
  Serial.print(F("°  Roll=")); Serial.print(roll, 1);
  Serial.println(F("°"));

  Serial.print(F("Pressure    → ")); Serial.print(pressure, 2);
  Serial.print(F(" hPa   Alt=")); Serial.print(altitude, 2);
  Serial.println(F(" m"));

  delay(500);
}
